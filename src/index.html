<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sqlite3 Viewer</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="autocomplete.js"></script>
  <script src="CookieReader.js"></script>
  <script src="CookieWriter.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
  <script>
    var query_history = [];
    const query_history_key = "query_history";
    function on_query_click() {
      let query_text = document.getElementById('sql_query_text').value;
      let url = new URL(document.location);
      url.searchParams = new URLSearchParams();
      url.searchParams.set('sql_query', query_text);
      window.location.href = url;
    }

    function run_sql_query(query_text) {
      let req = new XMLHttpRequest();
      req.open("GET", `sql_query=${query_text}`);
      req.onreadystatechange = function () {
        console.log("received query results");
        document.getElementById("sql_output_table").innerHTML = req.responseText;
      };
      console.info("Echo cookie: " + document.cookie);
      let queries_cookie = CookieReader.read(document.cookie, "sql_queries");
      console.info("Queries cookie: " + queries_cookie);
      req.send();
    }

    function on_loaded() {
      console.info("query history length: " + query_history.length);
      let url = window.location.search;
      let query_history_str = localStorage.getItem(query_history_key);
      let count = 0;
      let id = 0;
      if (query_history_str != null) {
        for (let query of query_history_str.split(';')) {
          if (query && query != "null" && !(query_history.includes(query))) {
            console.info("adding query to history: " + query);
            query_history.push(query);
          }
        }
      }
      console.info("query history length: " + query_history.length);
      var bobloblaw = new AutoComplete(document, document.getElementById('sql_query_text'), query_history);
      let sql_query = decodeURIComponent(new URL(document.location).searchParams.get('sql_query'));
      if (sql_query != undefined) {
        document.getElementById('sql_query_text').value = sql_query;
        if (!(sql_query in query_history)) {
          // query_history.push(sql_query);
          query_history_str += ';' + sql_query;
          localStorage.setItem(query_history_key, query_history_str);
        }
        run_sql_query(sql_query);
      }
      // document.window.addEventListener("keydown", event => {
      //   console.log("Event key str (win): " + event.key);
      // });
      $("input").keydown(function (e) {
        console.log("Event key str (win): " + event.key);
        if (e.which === 27) alert('escape pressed');
      });
      document.querySelector("#sql_query_text").addEventListener("keydown", event => {
        console.log("Event key str: " + event.key);
        if (event.key == "Escape") {
          bobloblaw.closeAllLists();
        }
        if (event.key == "Enter") {
          event.preventDefault();
          on_query_click();
        }
      });
    }

    query_history = [];
    console.info("query history is empty: " + query_history.length);
    document.addEventListener("DOMContentLoaded", on_loaded);
  </script>
</head>

<body>
  <div id="sql_input_panel">
    <input id="sql_query_text" name="sql_query" placeholder="Enter SQL Query" rows=1 autocomplete="off"></input>
    <div id="autocomplete-dropdown" class="autocomplete-items"></div>
    <button id="execute_query_bn" onclick="on_query_click()">Query</button>
  </div>
  <section id="sql_output_panel">
    <table id="sql_output_table"></table>
  </section>
</body>

</html>
