<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sqlite3 Viewer</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="autocomplete.js"></script>
    <script src="CookieReader.js"></script>
    <script src="CookieWriter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script>
    const query_history_key = "query_history";
    const query_param = 'sql_query';
    
    function on_query_click() {
      let query_text = document.getElementById('sql_query_text').value;
      let url = new URL(document.location);
      url.searchParams = new URLSearchParams();
      url.searchParams.set('sql_query', query_text);
      window.location.href = url;
    }

    function run_sql_query(query_text) {
      if (!query_text) {
        return;
      }
      let req = new XMLHttpRequest();
      req.open("GET", `${query_param}=${query_text}`);
      req.onreadystatechange = function () {
        console.log(`Received sql query results.  XMLHttpResponse readystate:
          ${this.readyState}, status: ${this.status}, statusText:
          ${this.statusText}`);
        document.getElementById("sql_output_table").innerHTML = this.responseText;
      };
      req.send();
    }

    function read_query_history_from_storage(query_history_str) {
      let query_history = [];
      if (query_history_str != null) {
        for (let query of query_history_str.split(';')) {
          if (query && query != "null" && !(query_history.includes(query))) {
            console.info("adding query to history: " + query);
            query_history.push(query);
          }
        }
      }
      return query_history;
    }

    function get_url_query_param() {
      return decodeURIComponent(
        new URL(document.location)
        .searchParams
        .get('sql_query'));
    }

    function on_loaded() {
      let query_history_str = localStorage.getItem(query_history_key);
      let query_history = read_query_history_from_storage(query_history_str);
      let sql_query = get_url_query_param();
      if (sql_query != undefined) {
        document.getElementById('sql_query_text').value = sql_query;
        if (!query_history.includes(sql_query)) {
          query_history_str += ';' + sql_query;
          localStorage.setItem(query_history_key, query_history_str);
        }
        run_sql_query(sql_query);
      }
      document.querySelector("#sql_query_text").addEventListener("keydown", event => {
        if (event.key == "Enter") {
          event.preventDefault();
          // if (!autocomplete.any_active()) {
            on_query_click();
          // }
        }
      });
    }

    // console.info("query history num entries: " + query_history.length);
    document.addEventListener("DOMContentLoaded", on_loaded);
    </script>
  </head>
  <body>
    <form id="sql_input_panel">
      <input
        id="sql_query_text"
        name="sql_query"
        list="autocomplete-dropdown"
        placeholder="Enter SQL Query"
        maxlength="256"
        rows="1"
      >
      <datalist id="autocomplete-dropdown" class="autocomplete-items"></datalist>
    </input>
    <input type="submit">
    <!-- <button id="execute_query_bn" onclick="on_query_click()">Query</button> -->
  </form>
  <section id="sql_output_panel">
    <table id="sql_output_table" display="none"></table>
  </section>
</body>
</html>
